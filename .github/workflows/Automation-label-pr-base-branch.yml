name: Automation-label-pr-base-branch
run-name: "[Automation-label-pr-base-branch] ${{ github.event.inputs.PR_NUMBER || github.ref }}"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.PR_NUMBER || github.ref }}
  cancel-in-progress: true

on:
  workflow_call:
    inputs:
      # PR Number
      PR_NUMBER:
        required: true
        type: string
    secrets:
      GH_TOKEN:
        description: "GitHub token for API access"
        required: true
jobs:
  label-pr-base-branch:
    name: Label PR Base Branch
    continue-on-error: true
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Label PR by Base Branch
        id: label-pr-base-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ inputs.PR_NUMBER }}"
          REPO="${{ github.repository }}"

          echo "ğŸ“¦ Processing PR #$PR_NUMBER in repo $REPO"

          # å–å¾— PR çš„ base branch
          BASE_BRANCH=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json baseRefName --jq '.baseRefName')
          echo "ğŸ”– PR Base Branch: $BASE_BRANCH"

          # å…è¨±çš„ base branch labels
          BRANCH_LABELS=("develop" "main" "master")

          # Label æ˜¯å¦åœ¨å…è¨±åˆ—è¡¨
          if [[ " ${BRANCH_LABELS[@]} " =~ " ${BASE_BRANCH} " ]]; then
            LABEL="$BASE_BRANCH"
          else
            echo "âš ï¸ Base branch '$BASE_BRANCH' not in allowed list, skipping label."
            exit 0
          fi

          # ç§»é™¤ç¾æœ‰çš„ base branch labels
          EXISTING_LABELS=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json labels --jq '.labels[].name')
          for EXISTING in $EXISTING_LABELS; do
            if [[ " ${BRANCH_LABELS[@]} " =~ " ${EXISTING} " ]]; then
              echo "ğŸ§¹ Removing existing base branch label: $EXISTING"
              gh pr edit "$PR_NUMBER" --repo "$REPO" --remove-label "$EXISTING"
            fi
          done

          # å¦‚æœ Label ä¸å­˜åœ¨å‰‡å»ºç«‹
          if ! gh label list --repo "$REPO" | grep -q "^$LABEL$"; then
            echo "ğŸ†• Creating missing label: $LABEL"
            gh label create "$LABEL" --repo "$REPO" --description "PR targeting $LABEL branch" --color "ededed"
          else
            echo "âœ… Label '$LABEL' already exists"
          fi

          # åŠ ä¸Š base branch label
          echo "ğŸ·ï¸ Adding label '$LABEL' to PR #$PR_NUMBER"
          gh pr edit "$PR_NUMBER" --repo "$REPO" --add-label "$LABEL"
